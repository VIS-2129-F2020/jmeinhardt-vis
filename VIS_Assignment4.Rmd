---
title: "Assignment 4: Isochromes"
author: "Julia Meinhardt"
date: "10/3/2020"
output: 
  html_document:
        toc: true
        toc_float: true
        code_folding: hide 
---

```{r setup, message=FALSE}

library(osmdata)
library(opentripplanner)
library(tidyverse)
library(sf)
library(ggthemes)
library(ggspatial)
library(raster)
library(wesanderson)
```

### Description

This analysis compares walksheds and bikesheds for climbing boulders within the city of Bozeman, Montana. 

**I used Mary's code to help put together my final bar chart! I learned how to create the new dataframe from her code, and she inspired me to finally try the Wes Anderson palette, which exceeded my expectations...Thanks Mary!** 


### Setup

```{r, loading kml, message=FALSE, results='hide' }

bzm_boulders <- st_read("https://opendata.arcgis.com/datasets/1931fd26d0cf4f0caee3173911ee9b5d_2.kml?outSR=%7B%22latestWkid%22%3A26912%2C%22wkid%22%3A26912%7D")
  
```
```{r, message=FALSE, results='hide'}
opq(bbox = 'Bozeman MT USA') %>%
  add_osm_feature(key = 'highway') %>%
  osmdata_xml(file = 'OTP/graphs/default/bozeman_streets.osm')
```

```{r,  message=FALSE, results='hide'}
MT_state_plane <- "+proj=lcc +lat_1=49 +lat_2=45 +lat_0=44.25 +lon_0=-109.5 +x_0=599999.9999976 +y_0=0 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048 +no_defs "


bozeman_street_features <- opq(bbox = 'Bozeman MT USA') %>%
  add_osm_feature(key = 'highway') %>%
  osmdata_sf()

bozeman_streets <- bozeman_street_features$osm_lines %>%
  st_transform(crs = MT_state_plane)
```

```{r,  message=FALSE, results='hide'}
ggplot(bozeman_streets) +
  geom_sf() +
  theme_map()
```

```{r,  message=FALSE, results='hide'}
path_data <- file.path(getwd(), "OTP")
path_otp <- paste(path_data, "otp.jar",sep = "/")

otp_build_graph(otp = path_otp, dir = path_data, memory = 1024) 
```


```{r,  message=FALSE, results='hide'}
otp_setup(otp = path_otp, dir = path_data, memory =1024)
```

```{r,  message=FALSE, results='hide'}
otpcon <- otp_connect()
```
```{r message=FALSE, results='hide'}
iso_5min_walk <- 
  otp_isochrone(otpcon = otpcon, fromPlace = bzm_boulders, 
                mode = "WALK", cutoffSec = 300) %>%
  st_transform(crs = MT_state_plane) %>%
  mutate(mode = "walk")

iso_5min_bike <- 
  otp_isochrone(otpcon = otpcon, fromPlace = bzm_boulders, 
                mode = "BICYCLE", cutoffSec = 300) %>%
  st_transform(crs = MT_state_plane) %>%
  mutate(mode = "bike")

iso_all_modes <- rbind(iso_5min_bike, iso_5min_walk)


```

```{r,  message=FALSE, results='hide'}
otp_stop()
```


### Figure 1


```{r}
right_side <- st_bbox(iso_all_modes)$xmax
left_side  <- st_bbox(iso_all_modes)$xmin
top_side <- st_bbox(iso_all_modes)$ymax
bottom_side <- st_bbox(iso_all_modes)$ymin

ggplot(iso_all_modes) +
  annotation_map_tile(zoomin = 0, type = "stamenbw", progress = "none") +
  geom_sf(aes(fill = mode), alpha = 0.5) +
  geom_sf(data = bzm_boulders) +
  coord_sf(xlim = c(left_side, right_side), 
           ylim = c(bottom_side, top_side), expand = FALSE) +
 scale_fill_manual(name = "Area that is reachable within 5 minutes",
                    values = wes_palette("FantasticFox1", n = 2),
                    labels = c("By bike", "By foot")) +
  theme_map() +
  labs(caption = "Basemap Copyright OpenStreetMap contributors")
```


### Figure 2 

 
```{r}
iso_areas <- iso_all_modes %>%
  mutate(area = st_area(iso_all_modes)) %>%
  st_set_geometry(NULL) %>%
  pivot_wider(names_from = mode, values_from = area) 

ggplot(iso_areas, 
       aes(x = as.numeric(walk), y = as.numeric(bike))) +
  geom_point() +
  scale_x_continuous(name = 
            "Area within a five-minute walking distance\nof a boulder\n(square km)",
            breaks = breaks <- seq(10000, 8000000, by = 100000),
            labels = breaks / 100000) +
  scale_y_continuous(name = 
            "Area within a five-minute biking distance\nof a boulder\n(square km)",
           breaks = breaks <- seq(10000, 8000000, by = 1000000),
            labels = breaks / 1000000) +
  theme_bw()
```


### Figure 3 


```{r}
iso_areas_2 <- data.frame(mode = rep(c("Bicycle", "Walk"), each = 8),
                          boulder =rep(c("1",
                              "2",
                              "3",
                              "4",
                              "5",
                              "6",
                              "7",
                              "8")),
                          area = c(iso_areas$bike, iso_areas$walk))
ggplot(iso_areas_2,
       aes(x = as.numeric(area) , y = boulder, fill = mode)) +
  geom_bar(stat = "identity", width = 0.5, position = "dodge") +
  scale_x_continuous(name = "Area Covered (square km)",
                     breaks = breaks <- seq(10000, 8000000, by = 1000000),
                     labels = breaks / 1000000) +
  scale_y_discrete(name = "Boulder ")+
  scale_fill_manual(name = "Area Covered by Biking and Walking",
                    values = wes_palette("FantasticFox1", 2, type = c("discrete")),
                    labels = c("Bicycle",
                               "Walk")) +
  labs(title = "Isochrome Area Calculations for Climbing Boulders in Bozeman, MT")+
  theme_minimal()


```

